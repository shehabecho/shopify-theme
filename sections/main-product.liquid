<div class="product-page">
  <div class="product-container">
    <div class="product-gallery">
      {% if product.featured_media %}
        <div class="product-main-image">
          <img
            src="{{ product.featured_media | image_url: width: 800 }}"
            alt="{{ product.featured_media.alt | escape }}"
            class="product-image"
          >
        </div>
      {% endif %}

      {% if product.media.size > 1 %}
        <div class="product-thumbnails">
          {% for media in product.media limit: 4 %}
            <button class="thumbnail" data-media-id="{{ media.id }}">
              <img
                src="{{ media | image_url: width: 150 }}"
                alt="{{ media.alt | escape }}"
              >
            </button>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="product-info">
      <h1 class="product-title">{{ product.title }}</h1>

      <div class="product-price">
        {% if product.compare_at_price > product.price %}
          <span class="price-sale">{{ product.price | money }}</span>
          <span class="price-compare">{{ product.compare_at_price | money }}</span>
        {% else %}
          <span class="price-regular">{{ product.price | money }}</span>
        {% endif %}
      </div>

      {% if product.description != blank %}
        <div class="product-description">
          {{ product.description }}
        </div>
      {% endif %}

      <form method="post" action="/cart/add" class="product-form">
        <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

        {% unless product.has_only_default_variant %}
          <div class="product-variants">
            {% for option in product.options_with_values %}
              <div class="variant-option">
                <label>{{ option.name }}</label>
                <select name="options[{{ option.name }}]" class="variant-select">
                  {% for value in option.values %}
                    <option value="{{ value }}">{{ value }}</option>
                  {% endfor %}
                </select>
              </div>
            {% endfor %}
          </div>
        {% endunless %}

        <div class="product-quantity">
          <label>Quantity</label>
          <input type="number" name="quantity" value="1" min="1" class="quantity-input">
        </div>

        <button
          type="submit"
          name="add"
          class="btn btn-add-to-cart"
          {% unless product.available %}
            disabled
          {% endunless %}
        >
          {% if product.available %}
            Add to Cart
          {% else %}
            Sold Out
          {% endif %}
        </button>
      </form>
    </div>
  </div>
</div>

{% stylesheet %}
  .product-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .product-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
  }

  .product-gallery {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .product-main-image {
    width: 100%;
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: 0.5rem;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product-thumbnails {
    display: flex;
    gap: 0.5rem;
  }

  .thumbnail {
    width: 80px;
    height: 80px;
    border: 2px solid transparent;
    border-radius: 0.25rem;
    cursor: pointer;
    padding: 0;
    background: none;
  }

  .thumbnail:hover,
  .thumbnail.active {
    border-color: var(--color-primary, #007bff);
  }

  .thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product-info {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .product-title {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
  }

  .product-price {
    display: flex;
    gap: 1rem;
    align-items: baseline;
    font-size: 1.5rem;
    font-weight: 600;
  }

  .price-sale {
    color: #d9534f;
  }

  .price-compare {
    color: #999;
    text-decoration: line-through;
    font-size: 1.25rem;
  }

  .product-description {
    line-height: 1.6;
    color: #666;
  }

  .product-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .variant-option {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .variant-option label {
    font-weight: 600;
  }

  .variant-select {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 0.25rem;
    font-size: 1rem;
  }

  .product-quantity {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .quantity-input {
    width: 100px;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 0.25rem;
    font-size: 1rem;
  }

  .btn-add-to-cart {
    padding: 1rem 2rem;
    background-color: var(--color-primary, #007bff);
    color: white;
    border: none;
    border-radius: 0.25rem;
    font-size: 1.125rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-add-to-cart:hover:not(:disabled) {
    background-color: #0056b3;
  }

  .btn-add-to-cart:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  @media (max-width: 768px) {
    .product-container {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .product-title {
      font-size: 1.5rem;
    }
  }
{% endstylesheet %}

<script>
  // Thumbnail image switching
  document.querySelectorAll('.thumbnail').forEach((thumb) => {
    thumb.addEventListener('click', function () {
      const mainImage = document.querySelector('.product-main-image img');
      const newSrc = this.querySelector('img').src.replace('width=150', 'width=800');
      mainImage.src = newSrc;

      document.querySelectorAll('.thumbnail').forEach((t) => t.classList.remove('active'));
      this.classList.add('active');
    });
  });

  // Variant selection
  const productVariants = {{ product.variants | json }};
  const variantSelects = document.querySelectorAll('.variant-select');
  const idInput = document.querySelector('input[name="id"]');
  const addToCartBtn = document.querySelector('.btn-add-to-cart');
  const productForm = document.querySelector('.product-form');

  if (variantSelects.length > 0) {
    variantSelects.forEach((select) => {
      select.addEventListener('change', updateVariant);
    });
  }

  function updateVariant() {
    // Get selected options
    const selectedOptions = Array.from(variantSelects).map((select) => select.value);

    // Find matching variant
    const matchedVariant = productVariants.find(variant => {
      return variant.options.every((option, index) => option === selectedOptions[index]);
    });

    if (matchedVariant) {
      // Update hidden input with new variant ID
      idInput.value = matchedVariant.id;

      // Update button state
      if (matchedVariant.available) {
        addToCartBtn.removeAttribute('disabled');
        addToCartBtn.textContent = 'Add to Cart';
      } else {
        addToCartBtn.setAttribute('disabled', 'disabled');
        addToCartBtn.textContent = 'Sold Out';
      }
    } else {
      // Variant doesn't exist
      addToCartBtn.setAttribute('disabled', 'disabled');
      addToCartBtn.textContent = 'Unavailable';
    }
  }

  // AJAX Add to Cart
  if (productForm) {
    productForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = productForm.querySelector('[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Adding...';
      submitBtn.disabled = true;

      try {
        const formData = new FormData(productForm);
        const response = await fetch('/cart/add.js', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (response.ok) {
          // Open cart drawer if available
          if (window.cartDrawer) {
            window.cartDrawer.open();
            // Trigger cart update event
            document.dispatchEvent(new CustomEvent('cart:updated'));
          } else {
            // Fallback to cart page
            window.location.href = '/cart';
          }
        } else {
          console.error('Error adding to cart:', data);
          alert(data.description || 'Error adding to cart');
        }
      } catch (error) {
        console.error('Error:', error);
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });
  }
</script>

{% schema %}
{
  "name": "Product Information",
  "settings": [
    {
      "type": "header",
      "content": "Product Page Settings"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Color",
      "default": "#007bff"
    }
  ]
}
{% endschema %}
