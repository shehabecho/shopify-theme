<div class="related-products" data-product-id="{{ product.id }}">
  <h2 class="related-products__title">You May Also Like</h2>

  <div class="related-products__grid" id="related-products-grid">
    <!-- Products will be loaded here via JavaScript -->
    <div class="loading">Loading recommendations...</div>
  </div>
</div>

{% stylesheet %}
  .related-products {
    max-width: 1200px;
    margin: 4rem auto;
    padding: 2rem 1rem;
  }

  .related-products__title {
    font-size: 2rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: 2rem;
  }

  .loading {
    text-align: center;
    padding: 2rem;
    color: #666;
    grid-column: 1 / -1;
  }

  .related-products__grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 2rem;
  }

  .related-product-card {
    background: white;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
  }

  .related-product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  .related-product-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .related-product-image {
    aspect-ratio: 1;
    overflow: hidden;
  }

  .related-product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .related-product-card:hover .related-product-image img {
    transform: scale(1.05);
  }

  .related-product-info {
    padding: 1rem;
  }

  .related-product-title {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
    line-height: 1.3;
  }

  .related-product-price {
    display: flex;
    gap: 0.5rem;
    align-items: baseline;
    font-weight: 500;
  }

  .price-sale {
    color: #d9534f;
    font-size: 1.125rem;
  }

  .price-compare {
    color: #999;
    text-decoration: line-through;
    font-size: 0.875rem;
  }

  .price-regular {
    font-size: 1.125rem;
  }

  @media (max-width: 1024px) {
    .related-products__grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 768px) {
    .related-products__grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .related-products__title {
      font-size: 1.5rem;
    }
  }

  @media (max-width: 480px) {
    .related-products__grid {
      grid-template-columns: 1fr;
    }
  }
{% endstylesheet %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const productId = document.querySelector('.related-products').dataset.productId;
    const gridContainer = document.getElementById('related-products-grid');

    // Fetch product recommendations
    fetch(`/recommendations/products.json?product_id=${productId}&limit=4`)
      .then((response) => response.json())
      .then((data) => {
        if (data.products && data.products.length > 0) {
          renderProducts(data.products);
        } else {
          gridContainer.innerHTML = '<p class="loading">No related products found.</p>';
        }
      })
      .catch((error) => {
        console.error('Error fetching recommendations:', error);
        gridContainer.innerHTML = '<p class="loading">Unable to load recommendations.</p>';
      });

    function renderProducts(products) {
      gridContainer.innerHTML = '';

      products.forEach((product) => {
        const card = document.createElement('div');
        card.className = 'related-product-card';

        const imageUrl = product.featured_image
          ? product.featured_image.replace('.jpg', '_300x.jpg').replace('.png', '_300x.png')
          : '';

        const compareAtPrice = product.compare_at_price_max;
        const price = product.price_min;

        let priceHTML = '';
        if (compareAtPrice && compareAtPrice > price) {
          priceHTML = `
            <span class="price-sale">${formatMoney(price)}</span>
            <span class="price-compare">${formatMoney(compareAtPrice)}</span>
          `;
        } else {
          priceHTML = `<span class="price-regular">${formatMoney(price)}</span>`;
        }

        card.innerHTML = `
          <a href="${product.url}" class="related-product-link">
            <div class="related-product-image">
              ${imageUrl ? `<img src="${imageUrl}" alt="${product.title}" loading="lazy">` : ''}
            </div>
            <div class="related-product-info">
              <h3 class="related-product-title">${product.title}</h3>
              <div class="related-product-price">
                ${priceHTML}
              </div>
            </div>
          </a>
        `;

        gridContainer.appendChild(card);
      });
    }

    function formatMoney(cents) {
      return '$' + (cents / 100).toFixed(2);
    }
  });
</script>

{% schema %}
{
  "name": "Related Products",
  "settings": [
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 8,
      "step": 1,
      "label": "Number of products",
      "default": 4
    }
  ]
}
{% endschema %}
